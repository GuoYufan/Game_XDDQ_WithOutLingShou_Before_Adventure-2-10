import traceback, sys, math, copy


class FightEnd(Exception):
    def __str__(self):
        return "æœ¬åœºç»“æŸ!"
        
class Fight():
    def __init__(self,å·¦,å³):
        self.è¿›è¡Œé€‰æ‰‹å­˜æ¡£(å·¦,å³)        
        self.å…ˆæ‰‹æ–¹=None
        self.å…³é—­æˆ˜æŠ¥=False
        self.è°èƒœ=None
        self.ç¬¬å‡ å›åˆ=0
        self.ç¬¬å‡ åœº=0
        self.å…³é—­è¿æš´å=False        
        self._æœ¬åœºç»“æŸ=False
        self.æœ€å¤§å›åˆæ•°=15
        self.ç´¯è®¡è§¦å‘è¿å‡»=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),0)
        self.ç´¯è®¡è§¦å‘åå‡»=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),0)
        self.ç´¯è®¡è§¦å‘æš´å‡»=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),0)
        self.è·èƒœæ¬¡æ•°=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),0)
        self.å‚èµ›æ¬¡æ•°=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),0)
        self.å¹³å±€æ¬¡æ•°=0
        self.å†å²å°†æ•Œäººå‹åˆ°æœ€ä½è¡€çº¿={
        	self.å·¦.åç§°:{"æ•°å€¼":0,"é‚£ä¸€åœºé™„å¸¦ä¿¡æ¯":""},
            	self.å·¦.å¯¹æ‰‹.åç§°:{"æ•°å€¼":0,"é‚£ä¸€åœºé™„å¸¦ä¿¡æ¯":""}
        	}
        self.ç¬¬ä¸€æ¬¡ä½¿æ•Œäººæ‰ä¸€ç®¡è¡€=dict.fromkeys((self.å·¦.åç§°,self.å·¦.å¯¹æ‰‹.åç§°),"")

    
    @property
    def æœ¬åœºç»“æŸ(self):return self._æœ¬åœºç»“æŸ
    
    @æœ¬åœºç»“æŸ.setter
    def æœ¬åœºç»“æŸ(self,value):
        self._æœ¬åœºç»“æŸ=value
        if value:
            self.æˆ˜åœºç»Ÿè®¡çš„å˜åŒ–()
                        
    
    def æˆ˜åœºç»Ÿè®¡çš„å˜åŒ–(self):
        if self.è°èƒœ==None:
            self.å¹³å±€æ¬¡æ•°+=1
        else:
            self.è·èƒœæ¬¡æ•°[self.è°èƒœ.åç§°]+=1            
        self.å‚èµ›æ¬¡æ•°[self.å·¦.åç§°]+=1
        self.å‚èµ›æ¬¡æ•°[self.å·¦.å¯¹æ‰‹.åç§°]+=1
    
    def è¿›è¡Œé€‰æ‰‹å­˜æ¡£(self,å·¦,å³):
        self.å·¦=self.å·¦_å­˜æ¡£=å·¦
        self.å·¦_å­˜æ¡£.å¯¹æ‰‹=å³
        self.å·¦_å­˜æ¡£.å¯¹æ‰‹.å¯¹æ‰‹=å·¦
        for _ in (self.å·¦_å­˜æ¡£, self.å·¦_å­˜æ¡£.å¯¹æ‰‹):
            _.æˆ˜åœº=self
            _.è®°è€….é€‰æ‰‹=_
            for key in _.buff:
                _.buff[key].role=_
            for key in _.debuff:
                _.debuff[key].role=_ 
        
            
    def è®¾ç½®åŒæ–¹(self):
        self.å·¦=copy.deepcopy(self.å·¦_å­˜æ¡£)
        self.å·¦.å¯¹æ‰‹=copy.deepcopy(self.å·¦_å­˜æ¡£.å¯¹æ‰‹)
        self.å·¦.å¯¹æ‰‹.å¯¹æ‰‹=self.å·¦
        for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹):
            _.æˆ˜åœº=self
            _.è®°è€….é€‰æ‰‹=_
            for key in _.buff:
                _.buff[key].role=_
            for key in _.debuff:
                _.debuff[key].role=_
        
                
    def åˆ†å‡ºå…ˆåæ‰‹æ–¹(self):
        if self.å·¦.æ•>self.å·¦.å¯¹æ‰‹.æ•:
            self.å·¦.å“ªä¸€æ–¹="å…ˆæ‰‹"
            self.å·¦.å¯¹æ‰‹.å“ªä¸€æ–¹="åæ‰‹"
            self.å…ˆæ‰‹æ–¹=self.å·¦
        else:
            self.å·¦.å¯¹æ‰‹.å“ªä¸€æ–¹="å…ˆæ‰‹"
            self.å·¦.å“ªä¸€æ–¹="åæ‰‹"            
            self.å…ˆæ‰‹æ–¹=self.å·¦.å¯¹æ‰‹                        
            
    def å±•ç¤ºåŒæ–¹æˆ˜å‰é¢æ¿ä¿¡æ¯(self):
        [_.è®¡ç®—å•æ–¹é¢æ¿() for _ in (self.å·¦,self.å·¦.å¯¹æ‰‹)]
        
        for _ in (self.å·¦, self. å·¦.å¯¹æ‰‹):
            print("è¡€:%g æ”»:%g é˜²:%g æ•:%g"%(_.è¡€, _.æ”», _.é˜², _.æ•))
        print()
        
        words=[]
        word="%sä¸»çµå…½%sä¼¤%g%%(%g%%),æ²»ç–—%g%%(%g%%)"
        for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹):
            words.append( word%(
            _.åç§°, _.ä¸»çµå…½åç§°,
            _.é¢æ¿_ä¸»çµå…½ä¼¤ç™¾åˆ†æ¯”*100,
            _.é¢æ¿_ä¸»çµå…½ä¼¤ç™¾åˆ†æ¯”*100*(1+_.å¼ºçµ-_.å¯¹æ‰‹.å¼±çµ)*(1+_.å¢ä¼¤-_.å¯¹æ‰‹.å‡ä¼¤),
            	_.é¢æ¿_ä¸»çµå…½æ²»ç–—ç™¾åˆ†æ¯”*100,
            		_.é¢æ¿_ä¸»çµå…½æ²»ç–—ç™¾åˆ†æ¯”*100*(1+ _.å¼ºçµ - _.å¯¹æ‰‹.å¼±çµ),
            	))

        print(("|".join(words)).join("[]"))
                       
        
        print("[%sç²¾æ€ª%s|%sç²¾æ€ª%s]"%(
            	self.å·¦.åç§°,
            	",".join(self.å·¦.æºå¸¦ç²¾æ€ª),
            	self.å·¦.å¯¹æ‰‹.åç§°,
        	    ",".join(self.å·¦.å¯¹æ‰‹.æºå¸¦ç²¾æ€ª)
            	)
          	)        
        
        print("[%sç¥é€š%s|%sç¥é€š%s]"%(
            	self.å·¦.åç§°,
            	",".join(self.å·¦.æºå¸¦ç¥é€š),
            	self.å·¦.å¯¹æ‰‹.åç§°,
        	    ",".join(self.å·¦.å¯¹æ‰‹.æºå¸¦ç¥é€š)
            	)
          	)
                
        
        print("[%så¸è¡€ç‡%g%%,è¿å‡»ç‡%g%%,æš´å‡»ç‡%g%%,åå‡»ç‡%g%%%s"%(
            	self.å·¦.åç§°,
             self.å·¦.å¸-self.å·¦.å¯¹æ‰‹.æŠ—å¸,
             self.å·¦.è¿-self.å·¦.å¯¹æ‰‹.æŠ—è¿,
             self.å·¦.æš´-self.å·¦.å¯¹æ‰‹.æŠ—æš´,
             self.å·¦.å-self.å·¦.å¯¹æ‰‹.æŠ—å,
             "(å·²å…³é—­è¿æš´å)" if self.å…³é—­è¿æš´å else "",
             )
        	)
        	
        print("|%så¸è¡€ç‡%g%%,è¿å‡»ç‡%g%%,æš´å‡»ç‡%g%%,åå‡»ç‡%g%%%s]"%(
            	self.å·¦.å¯¹æ‰‹.åç§°,
             self.å·¦.å¯¹æ‰‹.å¸-self.å·¦.æŠ—å¸,
             self.å·¦.å¯¹æ‰‹.è¿-self.å·¦.æŠ—è¿,
             self.å·¦.å¯¹æ‰‹.æš´-self.å·¦.æŠ—æš´,
             self.å·¦.å¯¹æ‰‹.å-self.å·¦.æŠ—å,
             "(å·²å…³é—­è¿æš´å)" if self.å…³é—­è¿æš´å else "",
             )
        	)

    
    def å·¦èƒœå—(self):
        self.åˆ†å‡ºå…ˆåæ‰‹æ–¹()
        if self.å·¦.å“ªä¸€æ–¹=="å…ˆæ‰‹":
            if self.å·¦.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°<=self.å·¦.å¯¹æ‰‹.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°:return True
        else:
            if self.å·¦.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°<self.å·¦.å¯¹æ‰‹.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°:return True
        return False
    
    def è®¡ç®—åŒæ–¹é¢æ¿(self):
        [_.è®¡ç®—å•æ–¹é¢æ¿() for _ in (self.å·¦,self.å·¦.å¯¹æ‰‹)]
        self.åˆ†å‡ºå…ˆåæ‰‹æ–¹()
        self.é¢æ¿_è°èƒœ=self.å·¦ if self.å·¦èƒœå—() else self.å·¦.å¯¹æ‰‹

    
    def æ¨¡ç³Šæˆ˜å†µæŠ¥å‘Š(self):
        print("\x1b[7m",end="")
        print("\n\tã€Šæˆ˜åœºï¼šæ¨¡ç³Šæˆ˜å†µæŠ¥å‘Šã€‹\t",end="")
        print("\033[0m")
        self.è®¡ç®—åŒæ–¹é¢æ¿()
        print(f"æˆ‘æ‰“æ•Œå¤šå°‘å›åˆï¼š{self.å·¦.é¢æ¿_æ‰“å¯¹æ–¹å›åˆæ•°}â€”â€”{self.å·¦.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°}å›åˆ")
        print(f"æ•Œæ‰“æˆ‘å¤šå°‘å›åˆï¼š{self.å·¦.å¯¹æ‰‹.é¢æ¿_æ‰“å¯¹æ–¹å›åˆæ•°}â€”â€”{self.å·¦.å¯¹æ‰‹.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°}å›åˆ")
        print(f"æˆ‘æ‰“æ•Œä¸€ä¸‹æ‰è¡€ç™¾åˆ†æ¯”ï¼š{self.å·¦.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”*100:.2f}%â€”â€”{math.ceil(1/self.å·¦.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”)}å›åˆ")
        print(f"æ•Œæ‰“æˆ‘ä¸€ä¸‹æ‰è¡€ç™¾åˆ†æ¯”ï¼š{self.å·¦.å¯¹æ‰‹.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”*100:.2f}%â€”â€”{math.ceil(1/self.å·¦.å¯¹æ‰‹.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”)}å›åˆ")
        print(f"æˆ‘æ‰“æ•Œä¸€ä¸‹æœ‰è§†é˜²å¾¡ä¼¤ï¼š{int(self.å·¦.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤)}")
        print(f"æ•Œæ‰“æˆ‘ä¸€ä¸‹æœ‰è§†é˜²å¾¡ä¼¤ï¼š{int(self.å·¦.å¯¹æ‰‹.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤)}")
        print(f"æˆ‘æ‰“æ•Œä¸€ä¸‹å¸è¡€å›è¡€é‡ï¼š{self.å·¦.é¢æ¿_å¸è¡€å›è¡€é‡}")
        print(f"æ•Œæ‰“æˆ‘ä¸€ä¸‹å¸è¡€å›è¡€é‡ï¼š{self.å·¦.å¯¹æ‰‹.é¢æ¿_å¸è¡€å›è¡€é‡}")
        print(f"å…ˆæ‰‹æ–¹ï¼š{self.å…ˆæ‰‹æ–¹.åç§°}")
        print(f"è°èƒœï¼š{self.é¢æ¿_è°èƒœ.åç§°}")
        
        def æ˜¯å¦éœ€è¦å¯¹ç­–():
            nonlocal self
            return self.é¢æ¿_è°èƒœ.åç§°=="æ•Œ"
            
        def æä¾›å¯¹ç­–():
            nonlocal self
            
            å‡ ä¸ªå›åˆç»“æŸ=min(self.å·¦.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°,self.å·¦.å¯¹æ‰‹.é¢æ¿_æ‰“å¯¹æ–¹å®é™…å›åˆæ•°)
            æˆ‘å·²è¡ŒåŠ¨äº†å‡ ä¸ªå›åˆ=å‡ ä¸ªå›åˆç»“æŸ-(1 if self.å…ˆæ‰‹æ–¹==self.å·¦.å¯¹æ‰‹ else 0)
            æˆ‘å·²é€ æˆæ‰è¡€ç™¾åˆ†æ¯”=self.å·¦.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”*æˆ‘å·²è¡ŒåŠ¨äº†å‡ ä¸ªå›åˆ
            å¯¹ç­–_éœ€è¦è¿›è¡Œå¤šå°‘æ¬¡è¿å‡»=(1-æˆ‘å·²é€ æˆæ‰è¡€ç™¾åˆ†æ¯”)/self.å·¦.é¢æ¿_æœ‰è§†é˜²å¾¡ä¼¤ç™¾åˆ†æ¯”
          
            print(f"å¯¹ç­–ï¼šéœ€è¦è¿›è¡Œ{å¯¹ç­–_éœ€è¦è¿›è¡Œå¤šå°‘æ¬¡è¿å‡»}æ¬¡è¿å‡»")
            print(f"å¯¹ç­–ï¼šå¹³å‡æ¯å›åˆè¿›è¡Œ{å¯¹ç­–_éœ€è¦è¿›è¡Œå¤šå°‘æ¬¡è¿å‡»/å‡ ä¸ªå›åˆç»“æŸ}æ¬¡è¿å‡»)")
        
        if æ˜¯å¦éœ€è¦å¯¹ç­–():æä¾›å¯¹ç­–()

    
    # --- åŒ ä¸€ å¯¹ æ‰‹ è¿ ç»­ æ‰“ å¤š åœº å­˜ æ¡£ ---
    	
    def é‡æ–°å…¥åœº(self):
        self.__init__(self.å·¦_å­˜æ¡£,self.å·¦_å­˜æ¡£.å¯¹æ‰‹)

 
    # --- åª’ ä½“ æ´» åŠ¨ ä¸ èµ› ç¨‹ å®‰ æ’ ---
    
    def è®°è€…å¬å¼€å‘å¸ƒä¼š(self,è¿™å‡ åœº):
        print("\033[32;40m",end="")
        print(f"\n---ã€Šé’ˆå¯¹{è¿™å‡ åœº}è®°è€…å¬å¼€å‘å¸ƒä¼šã€‹---")
        print("\033[0m",end="")
        
        print("\033[1;34m")
        self.å·¦.è®°è€….å‘å¸ƒä¼š()
        print("\x1b[31m")
        self.å·¦.å¯¹æ‰‹.è®°è€….å‘å¸ƒä¼š()
        print("\033[0m")

    def ç¬¬ä¸€åœº(self):
        self.æˆ˜å†µæŠ¥å‘Š()
        self.è®°è€…å¬å¼€å‘å¸ƒä¼š("ç¬¬ä¸€åœº")

        
    def å†æ¥å¤šå°‘åœº(self):
        while True:
            answer=input("â“å†æ¥å¤šå°‘åœºï¼Ÿ\n(Q/q:é€€å‡º |R/r:åˆ‡æ¢å¼€å…³æˆ˜æŠ¥ |F/f:åˆ‡æ¢å¼€å…³è¿æš´å):\n\t")
            if answer.lower()=="q":
                return "quit"
            elif answer.lower()=="r":
                self.å…³é—­æˆ˜æŠ¥=not self.å…³é—­æˆ˜æŠ¥
                print("âš¡ï¸æˆ˜æŠ¥å·²å…³é—­\n" if self.å…³é—­æˆ˜æŠ¥ else "âš¡ï¸æˆ˜æŠ¥å·²å¼€å¯\n")  
                continue
            elif answer.lower()=="f":
                self.å…³é—­è¿æš´å=not self.å…³é—­è¿æš´å
                print("âš¡ï¸è¿æš´åå·²å…³é—­\n" if self.å…³é—­è¿æš´å else "âš¡ï¸è¿æš´åå·²å¼€å¯\n")
                continue
                
            try:åœºæ¬¡=int(answer)
            except:
                print("âŒåœºæ•°å¿…é¡»æ˜¯æ•´æ•°\n")
                continue
            if åœºæ¬¡<1:
                print("âŒåœºæ•°ä¸èƒ½å°äº1\n")
                continue
            break
            
        print("\033[32;40m",end="")
        print(f"\n---ã€Šå†æ¥{åœºæ¬¡}åœºï¼ˆç«åŠ›å…¨å¼€ï¼‰ã€‹---")
        print("\033[0m")
        
        if åœºæ¬¡>3:
            prompt=["â“åœºæ¬¡è¿‡å¤š(æ¯æ¬¡æœ€å¤šæ”¯æŒè¿ç»­3åœºæˆ˜å†µæ˜¾ç¤º(å·²",
            	"\x1b[7m", 
            	f"ç¬¬{self.ç¬¬å‡ åœº}åœº",
            	"\033[0m",
            	"))å¼ºåˆ¶å…³é—­æˆ˜æŠ¥ï¼Œæ˜¯å¦å…è®¸ï¼Ÿ",
            	"(å¦‚æœä¸å…è®¸ï¼Œåˆ™å¼ºåˆ¶å…³é—­åœºæ¬¡)\n(Enter(æ¨è):å¼ºåˆ¶å…³é—­æˆ˜æŠ¥ |å¦:å¼ºåˆ¶å…³é—­åœºæ¬¡)\n"]
            prompt="".join(prompt)
            answer=input(prompt)
            if not answer:self.å…³é—­æˆ˜æŠ¥=True
            else:åœºæ¬¡=0
        for i in range(åœºæ¬¡):
            self.æˆ˜å†µæŠ¥å‘Š()
        
        self.è®°è€…å¬å¼€å‘å¸ƒä¼š(f"è¿™{åœºæ¬¡}åœº")

    # --- æ¯åˆ°ä¸‹ä¸€åœºåˆ·æ–°åˆ æ¡£ ---
    def æ•´åœºæ•°æ®é‡ç½®(self):
        self.æœ¬åœºç»“æŸ=False
        self.è°èƒœ=None
        self.ç¬¬å‡ å›åˆ=0
        self.è®¾ç½®åŒæ–¹()


            
    def å›åˆå¼€å§‹(self):
        self.ç¬¬å‡ å›åˆ+=1        
        if not self.å…³é—­æˆ˜æŠ¥:print(f"ç¬¬{self.ç¬¬å‡ å›åˆ}å›åˆ\n~~~~~~")
        for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹):
            _.æ—¶åˆ»="å›åˆå¼€å§‹æ—¶"
        
    def æ˜¾ç¤ºè¯¥å›åˆæˆ˜æ–—ç»“æœ(self):
        words=[]
        word="%s%g(%.2f%%)"
        for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹):
            words.append(word%(_.åç§°, _.å‰©ä½™è¡€é‡, _.å·²æ‰è¡€é‡ç™¾åˆ†æ¯”))
            
        print("ï¼ˆç›®å‰å‰©ä½™è¡€é‡ï¼š"," VS ".join(words), "ï¼‰", sep="")
        
        
        if not any([_.ç¥é€šåŠŸèƒ½å¼€å¯ for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹)]):
            return
        words=[]
        word="%s%g(%.2f%%)"
        
        for _ in (self.å·¦, self.å·¦.å¯¹æ‰‹):
            words.append(word%(_.åç§°, _.å¦–æ°”))
                     
        print("ï¼ˆç›®å‰å¦–æ°”ï¼š"," VS ".join(words),"ï¼‰", sep="")
        
                
    def æˆ˜å†µæŠ¥å‘Š(self):
        self.ç¬¬å‡ åœº+=1
        if not self.å…³é—­æˆ˜æŠ¥:
            print("\x1b[7m",end="")
            print(f"\n\tã€Šæˆ˜åœºï¼šå‡†ç¡®æˆ˜å†µæŠ¥å‘Šã€‹ä¹‹ç¬¬{self.ç¬¬å‡ åœº}åœº\t",end="")
            print("\033[0m")
        self.æ•´åœºæ•°æ®é‡ç½®()
        #print(self.å·¦.å)       
        #input(self.å·¦.__dict__)
        
        if not self.å…³é—­æˆ˜æŠ¥:print("\nğŸ“\n---ã€Šè¿›å…¥æˆ˜æ–—ã€‹---\n")
        for i in range(self.æœ€å¤§å›åˆæ•°):
            self.å›åˆå¼€å§‹()
            self.åˆ†å‡ºå…ˆåæ‰‹æ–¹()
            try:
                self.å…ˆæ‰‹æ–¹.è½®åºåˆ°çµå…½()
                self.å…ˆæ‰‹æ–¹.å¯¹æ‰‹.è½®åºåˆ°çµå…½()
                self.å…ˆæ‰‹æ–¹.è½®åºåˆ°äººç‰©()
                self.å…ˆæ‰‹æ–¹.å¯¹æ‰‹.è½®åºåˆ°äººç‰©()
            except Exception as e:
                if not isinstance(e,FightEnd):
                    traceback.print_exc()
                    sys.exit(1)
                else:
                    if not self.å…³é—­æˆ˜æŠ¥:
                        print(type(e).__name__,e.__str__(),sep=":")     
                    self.æœ¬åœºç»“æŸ=True
                    break
            if not self.å…³é—­æˆ˜æŠ¥:self.æ˜¾ç¤ºè¯¥å›åˆæˆ˜æ–—ç»“æœ()
            
            # æœ¬åœºç»“æŸï¼šå›åˆæ•°å®Œäº†è¿˜æ‰“ä¸å®Œ
            if i+1==self.æœ€å¤§å›åˆæ•° and not self.è°èƒœ:
                self.æœ¬åœºç»“æŸ=True
                if not self.å…³é—­æˆ˜æŠ¥:print("\n(å›åˆæ•°æ‰“å®Œä»æœªå†³å‡ºèƒœè´Ÿ)")
            if not self.å…³é—­æˆ˜æŠ¥:print()
            self.å…ˆæ‰‹æ–¹.æ—¶åˆ»="å›åˆç»“æŸæ—¶"
            self.å…ˆæ‰‹æ–¹.å¯¹æ‰‹.æ—¶åˆ»="å›åˆç»“æŸæ—¶"
            
            
                     
            
